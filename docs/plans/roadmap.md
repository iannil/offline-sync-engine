# 研发路线图

## 总体计划

```
┌─────────────────────────────────────────────────────────────────┐
│                      离线同步引擎研发路线图                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  阶段一        阶段二          阶段三                            │
│  基础离线      流量优化        强一致性                          │
│  ────────     ────────       ────────                           │
│  1.5个月       1个月          2个月                              │
│                                                                  │
│  ┌─────────┐  ┌─────────┐    ┌─────────┐                       │
│  │ RxDB    │  │ 增量同步 │    │  Yjs    │                       │
│  │ 本地DB  │  │         │    │  CRDT   │                       │
│  │ Outbox  │  │ Protobuf│    │ 字段合并│                       │
│  │ LWW     │  │ 压缩    │    │         │                       │
│  └─────────┘  └─────────┘    │  tus    │                       │
│                              │ 断点续传│                       │
│                              └─────────┘                       │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## 阶段一：基础离线功能（1.5 个月）

### 目标

实现基本的离线数据读写和网络恢复后自动同步。

### 技术方案

- **本地存储**: RxDB / PouchDB
- **同步策略**: 简单的 Last-Write-Wins
- **传输格式**: JSON
- **冲突处理**: 时间戳比较

### 核心功能

#### 客户端
- [x] 架构设计
- [ ] RxDB 集成
- [ ] 本地 Schema 定义
- [ ] CRUD API 封装
- [ ] Outbox 队列实现
- [ ] 网络状态监听
- [ ] 指数退避重试
- [ ] Push/Pull 同步

#### 服务端
- [x] 架构设计
- [ ] 框架搭建
- [ ] 基础 API 端点
- [ ] Applier 模块
- [ ] LWW 冲突解决
- [ ] 变更日志（change_log）

### 交付物

| 交付物 | 说明 |
|--------|------|
| 客户端 SDK | v0.1.0，基础离线功能 |
| 服务端 API | v0.1.0，基础同步接口 |
| 演示应用 | 可运行的 Demo |
| 单元测试 | 覆盖率 > 60% |
| 技术文档 | API 文档、使用指南 |

### 验收标准

- [ ] 离线状态下可以正常读写数据
- [ ] 网络恢复后自动同步
- [ ] 简单冲突可以自动解决
- [ ] 基本用户操作流程完整

---

## 阶段二：流量优化（1 个月）

### 目标

实现增量同步和数据压缩，减少流量消耗 50% 以上。

### 技术方案

- **增量同步**: Vector Clock / Merkle Tree
- **数据压缩**: Protobuf
- **传输优化**: 批量处理

### 核心功能

#### 服务端
- [ ] change_log 优化
- [ ] since 参数支持
- [ ] 游标分页
- [ ] Protobuf 接口

#### 客户端
- [ ] 增量拉取
- [ ] Protobuf 编解码
- [ ] 批量推送优化
- [ ] 自适应批次大小

### 交付物

| 交付物 | 说明 |
|--------|------|
| 客户端 SDK | v0.2.0，增量同步 |
| 服务端 API | v0.2.0，Protobuf 支持 |
| 性能报告 | 流量对比测试 |

### 验收标准

- [ ] 只传输变更数据
- [ ] Protobuf 压缩率 > 40%
- [ ] 弱网（2G/3G）环境可用

---

## 阶段三：强一致性（2 个月）

### 目标

实现字段级冲突解决和大文件断点续传。

### 技术方案

- **冲突解决**: Yjs CRDT
- **文件上传**: tus 协议
- **实时推送**: WebSocket

### 核心功能

#### CRDT 集成
- [ ] Yjs 选型验证
- [ ] CRDT 状态存储
- [ ] 客户端 CRDT 绑定
- [ ] 服务端 CRDT 合并
- [ ] 字段级冲突解决

#### 文件上传
- [ ] tus 协议服务端
- [ ] tus 协议客户端
- [ ] 分片上传
- [ ] 断点续传

#### 实时同步
- [ ] WebSocket 服务端
- [ ] 客户端 WebSocket 连接
- [ ] 变更广播
- [ ] 心跳保活

### 交付物

| 交付物 | 说明 |
|--------|------|
| 客户端 SDK | v1.0.0，生产就绪 |
| 服务端 API | v1.0.0，完整功能 |
| 测试套件 | E2E 测试 |
| 部署文档 | 生产部署指南 |

### 验收标准

- [ ] 字段级冲突自动合并
- [ ] 大文件（>100MB）断点续传
- [ ] WebSocket 实时同步
- [ ] 生产环境可用

---

## 时间表

```
月份    1    2    3    4    5    6
        │    │    │    │    │    │
阶段一  ████████
阶段二            ██████
阶段三                  ████████████████
发布                                █
```

| 阶段 | 开始 | 结束 | 耗时 |
|------|------|------|------|
| 阶段一 | TBD | TBD | 6 周 |
| 阶段二 | TBD | TBD | 4 周 |
| 阶段三 | TBD | TBD | 8 周 |
| **总计** | - | - | **18 周 (~4.5 个月)** |

---

## 依赖关系

```
技术选型
    │
    ▼
阶段一 ──────────────────────────────────┐
    │                                    │
    ▼                                    │
阶段二 ────────────────────────────────┤
    │                                    │
    ▼                                    │
阶段三 ◄─────────────────────────────────┘
    │
    ▼
生产发布
```

---

## 风险与应对

| 风险 | 影响 | 概率 | 应对措施 |
|------|------|------|----------|
| 技术选型延误 | 高 | 中 | 提前做技术验证 |
| CRDT 复杂度过高 | 高 | 中 | 分阶段实现，先 LWW |
| 弱网测试困难 | 中 | 高 | 使用网络模拟工具 |
| 人员变动 | 中 | 低 | 完善文档，知识沉淀 |

---

## 资源需求

### 人力资源

| 角色 | 人数 | 投入时间 |
|------|------|----------|
| 前端开发 | 1-2 | 全程 |
| 后端开发 | 1-2 | 全程 |
| 测试工程师 | 1 | 阶段一开始 |
| 技术文档 | 1 | 兼职 |

### 基础设施

- 开发服务器
- 测试服务器（支持弱网模拟）
- CI/CD 环境
- 监控告警系统

---

## 下一步行动

1. **本周**
   - [ ] 召开技术选型会议
   - [ ] 确定后端技术栈
   - [ ] 确定首发平台

2. **下周**
   - [ ] 搭建开发环境
   - [ ] 创建项目骨架
   - [ ] 编写第一个原型

3. **本月**
   - [ ] 完成技术验证
   - [ ] 启动阶段一开发
