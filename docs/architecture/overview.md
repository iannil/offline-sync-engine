# 架构总览

## Local-First（本地优先）架构理念

### 传统架构 vs Local-First 架构

```
传统 Web 应用：
Client → API → Server DB
（网络断开时应用不可用）

Local-First 架构：
Client → Local DB ↔ Sync Engine ↔ Server DB
（始终可用，后台同步）
```

### 核心设计原则

1. **读写分离（物理级）**
   - UI 界面只读写本地数据库
   - 毫秒级响应，无网络延迟
   - 网络状态不影响用户体验

2. **后台同步**
   - 同步引擎作为独立的后台进程（Web Worker）
   - 监听网络状态，自动处理数据传输
   - 对用户完全透明

3. **乐观更新（Optimistic UI）**
   - 用户操作后立即反馈成功
   - 只要写入本地 DB 成功即视为成功
   - 无需等待服务器响应

## 三层架构模型

```
┌─────────────────────────────────────────────────────────────┐
│                        客户端应用                            │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │   UI Layer  │──│ Local Store │──│   Client SDK        │  │
│  │             │  │ (IndexedDB) │  │   (The Edge)        │  │
│  └─────────────┘  └─────────────┘  │  - Outbox Pattern   │  │
│                                      │  - Network Manager  │  │
│                                      └──────────┬──────────┘  │
└─────────────────────────────────────────────────┼─────────────┘
                                                   │
                                                   ▼
┌─────────────────────────────────────────────────────────────┐
│                    传输协议层（The Tunnel）                  │
│  - Delta Sync（增量同步）                                    │
│  - Vector Clock / Merkle Tree（差异检测）                    │
│  - tus Protocol（断点续传）                                   │
│  - Protobuf / MsgPack（数据压缩）                            │
└─────────────────────────────────────────────────────────────┘
                                                   │
                                                   ▼
┌─────────────────────────────────────────────────────────────┐
│                  服务端同步网关（The Hub）                    │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │   Applier   │  │   Arbiter   │  │   Push Service      │  │
│  │ (变更应用)   │  │ (冲突仲裁)   │  │   (WebSocket)       │  │
│  └──────┬──────┘  └──────┬──────┘  └─────────────────────┘  │
│         │                │                                       │
│         └────────────────┴───────────┬───────────────────────┘  │
│                                     ▼                          │
│                            ┌───────────────┐                   │
│                            │ Master DB     │                   │
│                            │ (MySQL/PG)    │                   │
│                            └───────────────┘                   │
└─────────────────────────────────────────────────────────────┘
```

## 数据流向

### 写入流程

1. 用户操作 → UI Layer
2. UI Layer → Client SDK（拦截）
3. Client SDK → 生成 Action 对象
4. Action → Outbox 队列（本地存储）
5. 本地数据库更新 → UI 立即反馈
6. 网络可用时 → Sync Engine 上传 Action
7. Server → Applier 应用变更
8. Server → 广播通知其他客户端

### 读取流程

1. 用户请求 → UI Layer
2. UI Layer → Local Store（直接返回）
3. 后台：Sync Engine 检查更新
4. 有更新 → 拉取合并到 Local Store
5. Local Store → UI 刷新
